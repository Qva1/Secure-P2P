<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P DEX Elite</title>

<style>
:root{
--bg:#0f172a;
--card:#1e293b;
--primary:#00c896;
--danger:#ef4444;
--text:#ffffff;
--gray:#94a3b8;
}

body{
margin:0;
font-family:system-ui;
background:var(--bg);
color:var(--text);
}

header{
padding:15px;
background:#0b1220;
display:flex;
justify-content:space-between;
align-items:center;
font-weight:bold;
}

.container{
max-width:600px;
margin:auto;
padding:15px;
}

.card{
background:var(--card);
padding:15px;
border-radius:12px;
margin-bottom:15px;
}

input{
width:100%;
padding:10px;
margin-top:8px;
border-radius:8px;
border:none;
outline:none;
}

button{
background:var(--primary);
border:none;
padding:10px;
border-radius:8px;
color:white;
cursor:pointer;
margin-top:8px;
width:100%;
font-weight:bold;
}

button:hover{
opacity:0.9;
}

.small{
font-size:12px;
color:var(--gray)
}

.hidden{
display:none
}
</style>
</head>

<body>

<header>
P2P DEX ELITE
<button onclick="logout()">Salir</button>
</header>

<div class="container">

<div id="auth">
<div class="card">
<h3>Acceso</h3>
<input id="username" placeholder="Usuario">
<input id="password" type="password" placeholder="Contraseña">
<button onclick="register()">Crear Cuenta</button>
<button onclick="login()">Entrar</button>
</div>
</div>

<div id="app" class="hidden">

<div class="card">
<b>Wallet</b><br><br>
Dirección:
<div class="small" id="address"></div><br>
Balance: <span id="balance"></span> USDT<br>
Reputación: ⭐ <span id="rep"></span>
</div>

<div class="card">
<b>Órdenes Disponibles</b>
<div id="orders"></div>
</div>

<div class="card">
<b>Blockchain (últimos bloques)</b>
<div id="chain"></div>
</div>

</div>
</div>

<script>

// -------- Estado --------

let users = JSON.parse(localStorage.getItem("users")) || [];
let orders = JSON.parse(localStorage.getItem("orders")) || [];
let blockchain = JSON.parse(localStorage.getItem("blockchain")) || [];
let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;

// -------- Helpers --------

function save(){
localStorage.setItem("users", JSON.stringify(users));
localStorage.setItem("orders", JSON.stringify(orders));
localStorage.setItem("blockchain", JSON.stringify(blockchain));
localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

async function sha256(str){
const buffer = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
return Array.from(new Uint8Array(buffer))
.map(b=>b.toString(16).padStart(2,"0"))
.join("");
}

async function generateAddress(username){
return "0x"+(await sha256(username + Date.now())).slice(0,40);
}

// -------- Auth --------

async function register(){
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");

if(!usernameInput.value || !passwordInput.value)
return alert("Completa todos los campos");

if(users.find(u=>u.username===usernameInput.value))
return alert("Ese usuario ya existe");

const address = await generateAddress(usernameInput.value);

const newUser = {
username: usernameInput.value,
password: passwordInput.value,
balance: 1000,
reputation: 5,
address
};

users.push(newUser);
save();
alert("Cuenta creada correctamente");
}

function login(){
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");

const user = users.find(u =>
u.username === usernameInput.value &&
u.password === passwordInput.value
);

if(!user) return alert("Usuario o contraseña incorrectos");

currentUser = user;
save();
init();
}

function logout(){
currentUser = null;
save();
location.reload();
}

// -------- App --------

function init(){
document.getElementById("auth").classList.add("hidden");
document.getElementById("app").classList.remove("hidden");
updateUI();
renderOrders();
renderChain();
}

function updateUI(){
document.getElementById("address").innerText = currentUser.address;
document.getElementById("balance").innerText = currentUser.balance;
document.getElementById("rep").innerText = currentUser.reputation;
}

// -------- Órdenes --------

function generarOrdenesDemo(){
orders = [
{id:1001,buyerName:"Carlos Méndez",amount:10,status:"Escrow"},
{id:1002,buyerName:"Ana Rodríguez",amount:25,status:"Escrow"},
{id:1003,buyerName:"Luis Fernández",amount:50,status:"Escrow"},
{id:1004,buyerName:"María López",amount:75,status:"Escrow"},
{id:1005,buyerName:"Jorge Castillo",amount:120,status:"Escrow"}
];
save();
}

function renderOrders(){
const ordersDiv = document.getElementById("orders");
ordersDiv.innerHTML = "";

orders.forEach(o=>{
ordersDiv.innerHTML += `
<div class="card">
<b>Orden #${o.id}</b><br>
Comprador: ${o.buyerName}<br>
Cantidad: ${o.amount} USDT<br>
Estado: ${o.status}<br>
${o.status==="Escrow" ? `<button onclick="completeOrder(${o.id})">Completar</button>` : ""}
</div>`;
});
}

async function completeOrder(id){
let order = orders.find(o=>o.id===id);
if(order.status==="Completada") return;

order.status="Completada";

const blockData = {
time: Date.now(),
orderId: id,
buyer: order.buyerName
};

const hash = await sha256(JSON.stringify(blockData));

blockchain.push({
index: blockchain.length,
data: blockData,
hash
});

currentUser.balance += order.amount;
currentUser.reputation += 1;

save();
updateUI();
renderOrders();
renderChain();
}

// -------- Blockchain --------

function renderChain(){
const chainDiv = document.getElementById("chain");
chainDiv.innerHTML="";

blockchain.slice(-5).forEach(b=>{
chainDiv.innerHTML += `
<div class="small">
Bloque #${b.index}<br>
Hash: ${b.hash.slice(0,30)}...
</div><hr>`;
});
}

// -------- Init --------

if(orders.length===0){
generarOrdenesDemo();
}

if(currentUser){
init();
}

</script>

</body>
  </html>
